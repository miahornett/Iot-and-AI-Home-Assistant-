/*
 * ALS-PT19 Light Sensor Testing Script
 * This script reads the analog value from GPIO 34 and provides 
 * a smoothed output for calibration.
 */

const int lightSensorPin = 34; // ALS-PT19 OUT pin connected to GPIO 34
const int threshold = 200;     // Initial guess for Day/Night threshold

// Smoothing variables
const int numReadings = 10;
int readings[numReadings];      // the readings from the analog input
int readIndex = 0;              // the index of the current reading
int total = 0;                  // the running total
int average = 0;                // the average

void setup() {
  Serial.begin(115200);
  
  // Configure the ADC for 0-3.3V range
  analogSetAttenuation(ADC_11db); 
  
  // Initialize all readings to 0
  for (int i = 0; i < numReadings; i++) {
    readings[i] = 0;
  }
  
  Serial.println("--- ALS-PT19 Light Sensor Test Initialized ---");
  Serial.println("Open Serial Plotter (Ctrl+Shift+L) to see the wave!");
}

void loop() {
  // 1. Rolling Average Logic (Smoothing the signal)
  total = total - readings[readIndex];
  readings[readIndex] = analogRead(lightSensorPin);
  total = total + readings[readIndex];
  readIndex = readIndex + 1;

  if (readIndex >= numReadings) {
    readIndex = 0;
  }

  average = total / numReadings;

  // 2. Determine State
  String state = (average > threshold) ? "Day/Bright" : "Night/Dark";

  // 3. Output for Serial Plotter
  // Formatting as "Label:Value" allows the Serial Plotter to graph them separately
  Serial.print("Raw_Value:");
  Serial.print(readings[readIndex-1]); // The most recent raw read
  Serial.print(",");
  Serial.print("Smoothed_Average:");
  Serial.print(average);
  Serial.print(",");
  Serial.print("Threshold:");
  Serial.print(threshold);
  Serial.print("  |  Status: ");
  Serial.println(state);

  delay(100); // Fast sampling for testing; change to 1000ms later
}
